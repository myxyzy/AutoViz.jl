<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Overlays · AutoViz.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">AutoViz.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../basics/">AutoViz Basics</a></li><li><a class="tocitem" href="../cameras/">Cameras</a></li><li class="is-active"><a class="tocitem" href>Overlays</a><ul class="internal"><li><a class="tocitem" href="#IDOverlay-1"><span>IDOverlay</span></a></li><li><a class="tocitem" href="#CarFollowingStatsOverlay-1"><span>CarFollowingStatsOverlay</span></a></li><li><a class="tocitem" href="#LineToFrontOverlay-1"><span>LineToFrontOverlay</span></a></li><li><a class="tocitem" href="#TextOverlay-1"><span>TextOverlay</span></a></li><li><a class="tocitem" href="#HistogramOverlay-1"><span>HistogramOverlay</span></a></li><li><a class="tocitem" href="#NeighborsOverlay-1"><span>NeighborsOverlay</span></a></li><li><a class="tocitem" href="#Custom-Overlays-1"><span>Custom Overlays</span></a></li></ul></li></ul></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../api/">API</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Overlays</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Overlays</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/sisl/AutoViz.jl/blob/master/docs/lit/tutorials/overlays.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Overlays-1"><a class="docs-heading-anchor" href="#Overlays-1">Overlays</a><a class="docs-heading-anchor-permalink" href="#Overlays-1" title="Permalink"></a></h1><p><a href="https://nbviewer.jupyter.org/github/sisl/AutoViz.jl/blob/gh-pages/dev/notebooks/overlays.ipynb"><img src="https://img.shields.io/badge/show-nbviewer-579ACA.svg" alt/></a></p><p>Overlays are useful to display additional information on top of a given driving scene. For example, they can be used to display the ID of the vehicle, their speed, or other useful information.</p><p>More generally, renderable objects that are passed to the render function are rendered in the order they are passed in. For example, if we pass a collection consisting of a roadway and a scene, the roadway is rendered first, and the scene is rendered on top of the roadway.</p><p>This behavior leaves the possibility to create overlays as well as &quot;underlays&quot; that may be drawn under the vehicles.</p><p>In this tutorial, we will use the same stadium scenario as shown in the camera example.</p><pre><code class="language-julia">using AutomotiveDrivingModels
using AutoViz
AutoViz.set_render_mode(:fancy)

nlanes = 2
nveh = 8
nticks = 100
timestep = 0.1

roadway = gen_stadium_roadway(nlanes)

scene = Scene([
    Entity(
        VehicleState(
            Frenet(roadway[LaneTag(1,rand(1:nlanes))], 10.0*i),  # position
            roadway, 4.0 + 2.0rand()  # speed
        ),
        VehicleDef(), i
    ) for i in 1:nveh
])

models = Dict((
    i =&gt; LatLonSeparableDriver(ProportionalLaneTracker(), IntelligentDriverModel())
    for i in 1:nveh
))
set_desired_speed!.(values(models), 8.0 .+ 4.0rand(nveh))

scenes = simulate(scene, roadway, models, nticks, timestep)</code></pre><p>The following code will help us to animate the simulation using <code>Reel</code></p><pre><code class="language-julia">using Reel

function animate(roadway, scenes, overlays, camera=TargetFollowCamera(3, zoom=15.))
    animation = roll(fps=1.0/timestep, duration=nticks*timestep) do t, dt
        i = Int(floor(t/dt)) + 1
        update_camera!(camera, scenes[i])
        renderables = [
            roadway, scenes[i], overlays[i]...
        ]
        render(renderables, camera=camera)
    end
    return animation
end</code></pre><p>The <code>animate</code> function defined above takes an <code>overlays</code> object which holds a list of overlays for every frame in <code>scenes</code>.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Note on compatibility: The interface for rendering overlays has changed in version 0.8 of AutoViz. In older versions of AutoViz, overlays were rendered by passing in the current scene and roadway explicitly. Since AutoViz 0.8, every renderable object must have the same interface. As a result, an overlay that requires the <code>roadway</code> or <code>scene</code> for rendering, must store those objects as internal variables.</p><p>(<code>AutoViz.RenderableOverlay</code> is an overlay that can be used as a wrapper around older overlays which rely on the <code>scene</code> and <code>roadway</code> objects. However, it is recommended that overlays implement the new interface for <code>add_renderable!</code> since <code>AutoViz.RenderableOverlay</code> may be removed in future versions.)</p></div></div><h2 id="IDOverlay-1"><a class="docs-heading-anchor" href="#IDOverlay-1">IDOverlay</a><a class="docs-heading-anchor-permalink" href="#IDOverlay-1" title="Permalink"></a></h2><p>Show IDs for all vehicles in the scene</p><pre><code class="language-julia">overlays = [[
    IDOverlay(scene=scene, x_off=-2, y_off=1)
] for scene in scenes]
animation = animate(roadway, scenes, overlays)</code></pre><pre><code class="language-none">&quot;stadium_id_overlay.gif&quot;</code></pre><p><img src="../stadium_id_overlay.gif" alt="stadium with ID overlay"/></p><h2 id="CarFollowingStatsOverlay-1"><a class="docs-heading-anchor" href="#CarFollowingStatsOverlay-1">CarFollowingStatsOverlay</a><a class="docs-heading-anchor-permalink" href="#CarFollowingStatsOverlay-1" title="Permalink"></a></h2><p>Diplays info about the front neighbor of a car such as the difference in velocity and the relative distance. Show statistics for vehicle 3:</p><h3 id="TODO:-overlay-name-is-not-very-descriptive-1"><a class="docs-heading-anchor" href="#TODO:-overlay-name-is-not-very-descriptive-1">TODO: overlay name is not very descriptive</a><a class="docs-heading-anchor-permalink" href="#TODO:-overlay-name-is-not-very-descriptive-1" title="Permalink"></a></h3><pre><code class="language-julia">overlays = [[CarFollowingStatsOverlay(
    scene=scene, roadway=roadway, target_id=3, font_size=20, color=colorant&quot;black&quot;
)] for scene in scenes]
animation = animate(roadway, scenes, overlays)</code></pre><pre><code class="language-none">&quot;stadium_car_stats_overlay.gif&quot;</code></pre><p><img src="../stadium_car_stats_overlay.gif" alt="stadium with car stats overlay"/></p><h2 id="LineToFrontOverlay-1"><a class="docs-heading-anchor" href="#LineToFrontOverlay-1">LineToFrontOverlay</a><a class="docs-heading-anchor-permalink" href="#LineToFrontOverlay-1" title="Permalink"></a></h2><p>Show the line to the front vehicle for vehicle 3</p><pre><code class="language-julia">overlays = [[
    LineToFrontOverlay(scene=scene, roadway=roadway, target_id=3)
] for scene in scenes]
animation = animate(roadway, scenes, overlays)</code></pre><pre><code class="language-none">&quot;stadium_line_front_overlay.gif&quot;</code></pre><p><img src="../stadium_line_front_overlay.gif" alt="stadium with ID overlay"/></p><h2 id="TextOverlay-1"><a class="docs-heading-anchor" href="#TextOverlay-1">TextOverlay</a><a class="docs-heading-anchor-permalink" href="#TextOverlay-1" title="Permalink"></a></h2><p>The <code>TextOverlay</code> displays some text at the desired location. By default, the coordinates are in camera pixels.</p><pre><code class="language-julia">overlays = [[TextOverlay(
    text=[&quot;Overlays are nice!&quot;, &quot;frame $(i)/$(length(scenes))&quot;],
    font_size=30, pos=VecE2(50.0, 100.0), color=colorant&quot;black&quot;,
    coordinate_system=:camera_pixels
)] for i in 1:length(scenes)]
animation = animate(roadway, scenes, overlays)</code></pre><pre><code class="language-none">&quot;stadium_text_overlay.gif&quot;</code></pre><p><img src="../stadium_text_overlay.gif" alt="stadium with text overlay"/></p><p>setting the <code>coordinate_system</code> keyword to <code>:scene</code> places the text in scene coordinates</p><pre><code class="language-julia">overlays = [[TextOverlay(
    text=[&quot;Scene Coordinates!&quot;],
    font_size=10+round(20cos(.01i)),
    pos=VecE2(2i, 40+round(20*sin(.002i))),
    color=colorant&quot;black&quot;, coordinate_system=:scene
)] for i in 1:length(scenes)]
animation = animate(roadway, scenes, overlays)</code></pre><pre><code class="language-none">&quot;stadium_moving_text_overlay.gif&quot;</code></pre><p><img src="../stadium_moving_text_overlay.gif" alt="stadium with moving text overlay"/></p><h2 id="HistogramOverlay-1"><a class="docs-heading-anchor" href="#HistogramOverlay-1">HistogramOverlay</a><a class="docs-heading-anchor-permalink" href="#HistogramOverlay-1" title="Permalink"></a></h2><p>Display a bar at the specified position <code>pos</code>. The bar has dimensions <code>width</code> and <code>height</code> and is filled up to a given proportion of its height. The fill proportion is set using <code>val</code>, which should be a number between 0 and 1. If it is 0, the bar is not filled, if it is 1 it is filled to the top. The default units are in the camera frame.</p><pre><code class="language-julia">max_speed = 14.0
overlays = [[HistogramOverlay(
    pos=VecE2(40.0, 100.0), val=get_by_id(scene, 1).state.v/max_speed, label=&quot;veh1 speed&quot;,
    fill_color=colorant&quot;blue&quot;, line_color=colorant&quot;black&quot;,
    font_size=24, width=10, height=50
)] for scene in scenes]
animation = animate(roadway, scenes, overlays)</code></pre><pre><code class="language-none">&quot;stadium_histogram_overlay.gif&quot;</code></pre><p><img src="../stadium_histogram_overlay.gif" alt="stadium with moving text overlay"/></p><h2 id="NeighborsOverlay-1"><a class="docs-heading-anchor" href="#NeighborsOverlay-1">NeighborsOverlay</a><a class="docs-heading-anchor-permalink" href="#NeighborsOverlay-1" title="Permalink"></a></h2><p>Draws a line between a vehicle and its neighbors.</p><pre><code class="language-julia">overlays = [[
    NeighborsOverlay(
        scene=scene, roadway=roadway, target_id=3,
        textparams=TextParams(color=colorant&quot;black&quot;)
    )
] for (i, scene) in enumerate(scenes)]
animation = animate(roadway, scenes, overlays)</code></pre><pre><code class="language-none">&quot;neighbors_overlay.gif&quot;</code></pre><p><img src="../neighbors_overlay.gif" alt="stadium with neighbors overlay"/></p><h2 id="Custom-Overlays-1"><a class="docs-heading-anchor" href="#Custom-Overlays-1">Custom Overlays</a><a class="docs-heading-anchor-permalink" href="#Custom-Overlays-1" title="Permalink"></a></h2><h3 id="Lane-Highlighting-1"><a class="docs-heading-anchor" href="#Lane-Highlighting-1">Lane Highlighting</a><a class="docs-heading-anchor-permalink" href="#Lane-Highlighting-1" title="Permalink"></a></h3><p>Just like roadways and vehicles, overlays are renderable objects. In order to make a custom overlay type renderable, one needs to implement the <code>add_renderable!(::RenderModel, ::YourOverlay)</code> function.</p><p>To define an overlay which highlights a lane, let&#39;s start by defining a custom type <code>LaneOverlay</code></p><pre><code class="language-julia">struct LaneOverlay
    lane::Lane
    roadway::Roadway
    color::Colorant
end

function AutoViz.add_renderable!(rendermodel::RenderModel, overlay::LaneOverlay)
    add_renderable!(rendermodel, overlay.lane, overlay.roadway, color_asphalt=overlay.color)
    return rendermodel
end</code></pre><p>We can now initiate a <code>LaneOverlay</code> object and pass it to the <code>render</code> function</p><pre><code class="language-julia">lane_overlay = LaneOverlay(roadway[LaneTag(1,1)], roadway, RGBA(0.0,0.0,1.0,0.5))
camera = TargetFollowCamera(3, zoom=15.)
update_camera!(camera, scene)
snapshot = render([roadway, lane_overlay, scene], camera=camera)
write(&quot;stadium_lane_overlay.svg&quot;, snapshot)</code></pre><p><img src="../stadium_lane_overlay.svg" alt="lane overlay"/></p><h3 id="Concentric-Rectangle-Overlay-1"><a class="docs-heading-anchor" href="#Concentric-Rectangle-Overlay-1">Concentric Rectangle Overlay</a><a class="docs-heading-anchor-permalink" href="#Concentric-Rectangle-Overlay-1" title="Permalink"></a></h3><p>In the following, we will show a more advanced example in which direct manipulation of the <code>CairoContext</code> is required. We will create an overlay which draws concentric rectangles around a vehicle with ID <code>target_id</code></p><pre><code class="language-julia">struct ConcentricRectOverlay
    target_id
    scene::Scene
    n::Int64
    color::Colorant
end</code></pre><p>We implement a new rendering function for concentric rectangles</p><pre><code class="language-">using Cairo

function render_concentric_rects(
    ctx::CairoContext,
    n::Int,
    x::Real, y::Real,
    w::Real, l::Real,
    yaw::Real,
    color::Colorant
)
    save(ctx)
    translate(ctx, x, y)
    rotate(ctx, yaw)

    for i in 1:n
        AutoViz.render_round_rect(
            ctx,
            0, 0, l+2(i-1), w+2(i-1), 1., (i-.5),
            RGBA(color.r, color.g, color.b, 1-i/n),
            true, false,
        )
    end

    restore(ctx)
end</code></pre><p>The <code>add_renderable</code> function adds the function defined above to the instruction stack of the render model via <code>add_instruction!</code>. A series of common rendering instructions are already implemented as part of the <code>AutoViz.jl</code> framework.</p><pre><code class="language-">function AutoViz.add_renderable!(rendermodel::RenderModel, overlay::ConcentricRectOverlay)
    veh = get_by_id(overlay.scene, overlay.target_id)
    x, y, yaw = posg(veh)
    w, l = AutomotiveDrivingModels.width(veh.def), length(veh.def)

    add_instruction!(
        rendermodel, render_concentric_rects,
        (overlay.n, x, y, w, l, yaw, overlay.color)
    )
    return rendermodel
end

concentric_rect_overlay = ConcentricRectOverlay(3, scene, 5, colorant&quot;green&quot;)
snapshot = render([roadway, concentric_rect_overlay, scene], camera=camera)
write(&quot;stadium_concentric_rect_overlay.svg&quot;, snapshot)</code></pre><p><img src="stadium_concentric_rect_overlay.svg" alt="lane overlay"/></p><pre><code class="language-julia">nothing</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../cameras/">« Cameras</a><a class="docs-footer-nextpage" href="../../api/">API »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 23 March 2020 00:06">Monday 23 March 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
